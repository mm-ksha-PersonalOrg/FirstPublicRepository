name: PR Review Validation

on:
  pull_request:
    types: [opened, edited, reopened, synchronize,ready_for_review]
  pull_request_review:
    types: [submitted]

jobs:
  validate-pr-template:
    name: Validate PR Template
    runs-on: ubuntu-latest
    
    steps:
      - name: Check PR Description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // Check if PR uses the template
            const requiredSections = [
              'Pull Request Information',
              'Internal ID:',
              'Private Issue:',
              'Public Issue:',
              'Risk Classification:',
              'Branch Protection Requirements',
              'Definition of Done Checklist',
              'Approval'
            ];
            
            const missingSections = requiredSections.filter(section => !body.includes(section));
            
            if (missingSections.length > 0) {
              core.setFailed(`PR description is missing required sections: ${missingSections.join(', ')}`);
              return;
            }
            
            // Check if Internal ID is filled
            if (body.includes('[Internal tracking ID]')) {
              core.warning('Internal ID is not filled in');
            }
            
            // Check if linked issue exists
            if (body.includes('Fixes #[issue number]') || body.includes('[issue number]')) {
              core.setFailed('PR must be linked to an issue. Please update "Public Issue" field.');
              return;
            }
            
            // Check if Risk Classification is selected
            const riskPattern = /Risk Classification:[\s\S]*?-\s*\[x\]/i;
            if (!riskPattern.test(body)) {
              core.warning('Risk Classification is not selected');
            }
            
            core.info('PR template validation passed');

      - name: Check Review Approval
        if: github.event_name == 'pull_request_review'
        uses: actions/github-script@v7
        with:
          script: |
            const review = context.payload.review;
            const pr = context.payload.pull_request;
            
            if (review.state === 'approved') {
              try {
                // Add approved label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['approved']
                });
                
                core.info(`PR #${pr.number} has been approved by ${review.user.login}`);
              } catch (error) {
                core.warning(`Could not add approved label: ${error.message}`);
              }
            }

  enforce-checklist:
    name: Enforce DoD Checklist
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'edited')
    
    steps:
      - name: Check Definition of Done
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // Count checked items in DoD Checklist
            const dodSection = body.match(/##\s*Definition of Done Checklist([\s\S]*?)(?=##|$)/);
            if (!dodSection) {
              core.warning('Definition of Done Checklist section not found');
              return;
            }
            
            const checkedItems = (dodSection[1].match(/-\s*\[x\]/gi) || []).length;
            const uncheckedItems = (dodSection[1].match(/-\s*\[\s*\]/gi) || []).length;
            const totalItems = checkedItems + uncheckedItems;
            
            if (totalItems === 0) {
              core.warning('No checklist items found in Definition of Done');
              return;
            }
            
            const completionRate = (checkedItems / totalItems * 100).toFixed(1);
            
            core.info(`DoD Checklist: ${checkedItems}/${totalItems} items checked (${completionRate}%)`);
            
            // Check if comment already exists
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });
            
            const botComment = comments.data.find(
              comment => comment.user.type === 'Bot' && 
                         comment.body.includes('## Definition of Done Status')
            );
            
            const commentBody = `## Definition of Done Status\n\n` +
                    `Progress: ${checkedItems}/${totalItems} items completed (${completionRate}%)\n\n` +
                    (completionRate < 100 ? '⚠️ Please complete all checklist items before requesting review.' : '✅ All checklist items completed!');
            
            try {
              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: commentBody
                });
              } else {
                // Add new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: commentBody
                });
              }
            } catch (error) {
              core.warning(`Could not create/update comment: ${error.message}`);
            }
            
            // Set status check
            if (completionRate < 100) {
              core.warning(`DoD Checklist incomplete: ${completionRate}% completed`);
            }


  check-linked-issue:
    name: Validate PR Linked Issue
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Setup PR context
        id: setup
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
      
      - name: Generate GitHub token
        id: generate-token
        run: |
          echo "token=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
      
      - name: Check if PR is linked to an issue
        id: check-linked-issue
        run: |
          PR_NUMBER=${{ steps.setup.outputs.pr_number }}
          REPO=${{ github.repository }}
          echo "::group::Checking PR #$PR_NUMBER for linked issues"
          echo "::notice title=PR Validation::Checking linked issues for PR #$PR_NUMBER"
          # Use gh pr view to get closing issues references
          RESULT=$(gh pr view $PR_NUMBER --repo "$REPO" --json closingIssuesReferences)
          ISSUE_COUNT=$(echo "$RESULT" | jq '.closingIssuesReferences | length')
          if [ "$ISSUE_COUNT" -gt 0 ]; then
            echo "✅ Found $ISSUE_COUNT linked issue(s)"
            echo "$RESULT" | jq -r '.closingIssuesReferences[] | "  • Issue #\(.number): \(.title) (\(.url))"'
            # Extract first issue number for further validation
            ISSUE_NUMBER=$(echo "$RESULT" | jq '.closingIssuesReferences[0].number')
            echo "::notice title=Linked Issue Found::Using issue #$ISSUE_NUMBER for downstream validation"
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          else
            echo "::endgroup::"
            echo "::notice title=Linked Issue Missing::No linked issues detected for PR #$PR_NUMBER"
            echo "::error title=Validation Failed: Missing Linked Issue::❌ This PR is not linked to any issue."
            echo ""
            echo "**Why this check failed:**"
            echo "This repository requires all PRs to be linked to at least one issue for tracking and documentation purposes."
            echo ""
            echo "**How to fix it:**"
            echo "Link an issue to this PR using the GitHub UI"
            echo ""
            echo "Once linked, the PR will automatically show the linked issue."
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}