name: PR Review Validation

# Trigger this workflow on pull request events and reviews
on:
  pull_request:
    types: [opened, edited, reopened, synchronize, ready_for_review]
  pull_request_review:
    types: [submitted]

jobs:
  # ============================================================================
  # Job 1: Validate PR Template Structure
  # ============================================================================
  # This job ensures that the PR description contains all required sections
  # from the PR template and validates that key fields are filled in.
  validate-pr-template:
    name: Validate PR Template
    runs-on: ubuntu-latest
    
    steps:
      - name: Check PR Description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // Define required sections that must be present in the PR description
            const requiredSections = [
              'Pull Request Information',
              'Internal ID:',
              'Private Issue:',
              'Public Issue:',
              'Branch Protection Requirements',
              'Definition of Done Checklist'
            ];
            
            // Check for missing sections
            const missingSections = requiredSections.filter(section => !body.includes(section));
            
            if (missingSections.length > 0) {
              core.setFailed(`PR description is missing required sections: ${missingSections.join(', ')}`);
              return;
            }
            
            // Validate that Internal ID field has been filled out
            if (body.includes('[Internal tracking ID]')) {
              core.warning('Internal ID is not filled in');
            }
            
            // Validate that issue linking fields are properly filled
            if (body.includes('Fixes #[issue number]') || body.includes('[issue number]')) {
              core.warning('PR must be linked to an issue. Please update "Public Issue" field.');
            }
            
            core.info('PR template validation passed');

  # ============================================================================
  # Job 2: Enforce Definition of Done (DoD) Checklist
  # ============================================================================
  # This job tracks completion of the DoD checklist items and posts/updates
  # a comment showing progress. Items marked with strikethrough (~) are
  # considered optional and excluded from the completion rate.
  enforce-checklist:
    name: Enforce DoD Checklist
    runs-on: ubuntu-latest
    # Only run when PR is opened or edited
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'edited')
    
    steps:
      - name: Check Definition of Done
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // Extract the Definition of Done section from PR description
            // Matches from "## Definition of Done Checklist" until next ## section or end
            const dodSection = body.match(/##\s*Definition of Done Checklist([\s\S]*?)(?=\n##\s+[^#]|$)/i);
            
            if (!dodSection) {
              core.warning('Definition of Done Checklist section not found');
              return;
            }
            
            const dodContent = dodSection[1];
            
            // ----------------------------------------------------------------
            // Count all checkbox items (both checked and unchecked)
            // ----------------------------------------------------------------
            // Matches patterns like: - [x] or - [ ]
            const allCheckedItems = (dodContent.match(/-\s*\[x\]/gi) || []).length;
            const allUncheckedItems = (dodContent.match(/-\s*\[\s*\]/gi) || []).length;
            
            // ----------------------------------------------------------------
            // Identify items marked as "not required" using strikethrough (~)
            // ----------------------------------------------------------------
            // Pattern 1: Checkbox followed by strikethrough text
            // Example: - [ ] ~Optional item~
            const strikethroughPattern = /-\s*\[[x\s]*\]\s*~[^~]+~/gi;
            const notRequiredItems = (dodContent.match(strikethroughPattern) || []).length;
            
            // Pattern 2: Entire line with strikethrough
            // Example: ~- [ ] Optional item~
            const altStrikethroughPattern = /~\s*-\s*\[[x\s]*\][^~]+~/gi;
            const notRequiredItemsAlt = (dodContent.match(altStrikethroughPattern) || []).length;
            
            // Total optional items to exclude from completion calculation
            const totalNotRequired = notRequiredItems + notRequiredItemsAlt;
            
            // ----------------------------------------------------------------
            // Calculate completion rate based on required items only
            // ----------------------------------------------------------------
            // Total required items = All items - Optional items
            const totalItems = allCheckedItems + allUncheckedItems - totalNotRequired;
            
            // Start with all checked items
            let checkedItems = allCheckedItems;
            
            // Subtract checked items that are marked as optional (strikethrough)
            const checkedStrikethroughPattern = /-\s*\[x\]\s*~[^~]+~/gi;
            const checkedNotRequired = (dodContent.match(checkedStrikethroughPattern) || []).length;
            
            const altCheckedStrikethroughPattern = /~\s*-\s*\[x\][^~]+~/gi;
            const altCheckedNotRequired = (dodContent.match(altCheckedStrikethroughPattern) || []).length;
            
            // Final count of checked required items
            checkedItems = checkedItems - checkedNotRequired - altCheckedNotRequired;
            
            // ----------------------------------------------------------------
            // Log detailed information for debugging
            // ----------------------------------------------------------------
            core.info(`Total checklist items: ${allCheckedItems + allUncheckedItems}`);
            core.info(`Not required items (marked with ~): ${totalNotRequired}`);
            core.info(`Required items: ${totalItems}`);
            core.info(`Checked required items: ${checkedItems}`);
            
            // Early exit if no checklist items found
            if (totalItems === 0) {
              core.warning('No checklist items found in Definition of Done');
              return;
            }
            
            // Calculate percentage completion
            const completionRate = (checkedItems / totalItems * 100).toFixed(1);
            
            core.info(`DoD Checklist: ${checkedItems}/${totalItems} items checked (${completionRate}%)`);
            
            
            
            // ----------------------------------------------------------------
            // Set workflow status based on completion
            // ----------------------------------------------------------------
            // Issue a warning (not failure) if checklist is incomplete
            if (completionRate < 100) {
              core.warning(`DoD Checklist incomplete: ${completionRate}% completed`);
            }

  # ============================================================================
  # Job 3: Validate PR is Linked to an Issue
  # ============================================================================
  # This job ensures that every PR is linked to at least one issue for
  # proper tracking and documentation purposes. It fails the workflow if
  # no linked issues are found.
  check-linked-issue:
    name: Validate PR Linked Issue
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      # Step 1: Extract PR number from context
      - name: Setup PR context
        id: setup
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
      
      # Step 2: Setup GitHub token for API access
      - name: Generate GitHub token
        id: generate-token
        run: |
          echo "token=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
      
      # Step 3: Check for linked issues using GitHub CLI
      - name: Check if PR is linked to an issue
        id: check-linked-issue
        run: |
          PR_NUMBER=${{ steps.setup.outputs.pr_number }}
          REPO=${{ github.repository }}
          
          # Start collapsible log group for better readability
          echo "::group::Checking PR #$PR_NUMBER for linked issues"
          echo "::notice title=PR Validation::Checking linked issues for PR #$PR_NUMBER"
          
          # Use GitHub CLI to fetch closing issues references
          RESULT=$(gh pr view $PR_NUMBER --repo "$REPO" --json closingIssuesReferences)
          ISSUE_COUNT=$(echo "$RESULT" | jq '.closingIssuesReferences | length')
          
          # ----------------------------------------------------------------
          # Validate linked issues
          # ----------------------------------------------------------------
          if [ "$ISSUE_COUNT" -gt 0 ]; then
            # Success: Linked issues found
            echo "✅ Found $ISSUE_COUNT linked issue(s)"
            echo "$RESULT" | jq -r '.closingIssuesReferences[] | "  • Issue #\(.number): \(.title) (\(.url))"'
            
            # Extract first issue number for potential downstream validation
            ISSUE_NUMBER=$(echo "$RESULT" | jq '.closingIssuesReferences[0].number')
            echo "::notice title=Linked Issue Found::Using issue #$ISSUE_NUMBER for downstream validation"
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          else
            # Failure: No linked issues detected
            echo "::endgroup::"
            echo "::notice title=Linked Issue Missing::No linked issues detected for PR #$PR_NUMBER"
            echo "::error title=Validation Failed: Missing Linked Issue::❌ This PR is not linked to any issue."
            echo ""
            echo "**Why this check failed:**"
            echo "This repository requires all PRs to be linked to at least one issue for tracking and documentation purposes."
            echo ""
            echo "**How to fix it:**"
            echo "Link an issue to this PR using the GitHub UI"
            echo ""
            echo "Once linked, the PR will automatically show the linked issue."
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
